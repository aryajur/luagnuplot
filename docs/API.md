# Gnuplot Lua Module - API Reference

Complete API documentation for the `gnuplot` Lua module.

## Table of Contents

- [Module Loading](#module-loading)
- [Core Functions](#core-functions)
- [wxLua Terminal Functions](#wxlua-terminal-functions)
- [RGB Data Access](#rgb-data-access)
- [Complete Examples](#complete-examples)

## Module Loading

```lua
local gnuplot = require("gnuplot")
```

**Requirements:**
- `gnuplot.so` (Linux) or `gnuplot.dll` (Windows) must be in your `LUA_CPATH`
- `libgnuplot.so` (Linux) or `libgnuplot.dll` (Windows) must be in your library path

**Environment Setup:**
```bash
# Linux
export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
export LUA_CPATH='./?.so;;'

# Windows
set PATH=.;%PATH%
set LUA_CPATH=./?.dll;;
```

## Core Functions

### gnuplot.init()

Initialize the gnuplot library. Must be called before any other gnuplot operations.

**Syntax:**
```lua
gnuplot.init()
```

**Returns:** `nil`

**Example:**
```lua
local gnuplot = require("gnuplot")
gnuplot.init()
-- Now ready to execute commands
```

---

### gnuplot.cmd(command)

Execute a single gnuplot command.

**Syntax:**
```lua
gnuplot.cmd(command)
```

**Parameters:**
- `command` (string) - A gnuplot command string

**Returns:** `nil`

**Examples:**
```lua
-- Set terminal
gnuplot.cmd("set terminal svg size 800,600")

-- Set output file
gnuplot.cmd("set output 'plot.svg'")

-- Configure plot appearance
gnuplot.cmd("set title 'My Plot'")
gnuplot.cmd("set xlabel 'X axis'")
gnuplot.cmd("set ylabel 'Y axis'")
gnuplot.cmd("set grid")

-- Create plot
gnuplot.cmd("plot sin(x)")
```

**Common Commands:**

**Terminal selection:**
```lua
gnuplot.cmd("set terminal svg size 800,600")
gnuplot.cmd("set terminal png size 1024,768")
gnuplot.cmd("set terminal pngcairo size 1200,900")
gnuplot.cmd("set terminal wxlua size 1000,700")
```

**Output file:**
```lua
gnuplot.cmd("set output 'filename.svg'")
```

**Plot styling:**
```lua
gnuplot.cmd("set title 'Plot Title'")
gnuplot.cmd("set xlabel 'X Label'")
gnuplot.cmd("set ylabel 'Y Label'")
gnuplot.cmd("set grid")
gnuplot.cmd("set key top right")  -- Legend position
gnuplot.cmd("set xrange [-10:10]")
gnuplot.cmd("set yrange [-5:5]")
```

**Plotting:**
```lua
gnuplot.cmd("plot sin(x)")
gnuplot.cmd("plot sin(x), cos(x), tan(x)")
gnuplot.cmd("plot sin(x) title 'Sine', cos(x) title 'Cosine'")
gnuplot.cmd("splot x*y")  -- 3D plot
```

---

### gnuplot.close()

Clean up and close the gnuplot library. Should be called when done with plotting.

**Syntax:**
```lua
gnuplot.close()
```

**Returns:** `nil`

**Example:**
```lua
gnuplot.init()
gnuplot.cmd("set terminal svg")
gnuplot.cmd("set output 'plot.svg'")
gnuplot.cmd("plot sin(x)")
gnuplot.close()  -- Clean up
```

---

## wxLua Terminal Functions

The wxLua terminal allows you to capture gnuplot's drawing commands for rendering in wxWidgets applications.

### gnuplot.get_commands()

Retrieve the list of drawing commands generated by gnuplot when using the wxlua terminal.

**Syntax:**
```lua
local result = gnuplot.get_commands()
```

**Returns:**
- Table with the following structure:
  ```lua
  {
    width = number,      -- Canvas width in pixels
    height = number,     -- Canvas height in pixels
    commands = {         -- Array of command tables
      {type = CMD_MOVE, x = number, y = number},
      {type = CMD_VECTOR, x = number, y = number},
      {type = CMD_TEXT, x = number, y = number, text = string},
      {type = CMD_COLOR, color = number},  -- RGB as 0xRRGGBB
      {type = CMD_LINEWIDTH, value = number},
      {type = CMD_LINETYPE, x = number},
      -- ... more commands
    }
  }
  ```
- Or `nil` if no commands were captured

**Command Types:**
```lua
local CMD_MOVE = 0            -- Move to position (x, y)
local CMD_VECTOR = 1          -- Draw line to (x, y)
local CMD_TEXT = 2            -- Draw text at (x, y)
local CMD_COLOR = 3           -- Set drawing color
local CMD_LINEWIDTH = 4       -- Set line width
local CMD_LINETYPE = 5        -- Set line style
local CMD_POINT = 6           -- Draw point at (x, y)
local CMD_FILLBOX = 7         -- Draw filled box
local CMD_FILLED_POLYGON = 8  -- Draw filled polygon
local CMD_TEXT_ANGLE = 9      -- Set text rotation angle
local CMD_JUSTIFY = 10        -- Set text justification
local CMD_SET_FONT = 11       -- Set font
```

**Example:**
```lua
gnuplot.init()
gnuplot.cmd("set terminal wxlua size 800,600")
gnuplot.cmd("plot sin(x)")

local result = gnuplot.get_commands()

if result then
  print("Canvas size:", result.width, "x", result.height)
  print("Number of commands:", #result.commands)

  -- Process commands
  for i, cmd in ipairs(result.commands) do
    if cmd.type == CMD_MOVE then
      print("Move to", cmd.x, cmd.y)
    elseif cmd.type == CMD_VECTOR then
      print("Draw line to", cmd.x, cmd.y)
    elseif cmd.type == CMD_TEXT then
      print("Draw text:", cmd.text, "at", cmd.x, cmd.y)
    end
  end
end

gnuplot.close()
```

**Complete wxLua Rendering Example:**

See `wxlua_plot_perfect.lua` for a full implementation that:
- Captures commands with `get_commands()`
- Renders them using wxWidgets Device Context (wxDC)
- Uses wxGraphicsContext for anti-aliased rendering
- Implements path accumulation for smooth curves
- Handles all command types (text, colors, line styles, etc.)

---

## RGB Data Access

Get raw RGB pixel data directly from gnuplot's PBM terminal output.

### gnuplot.get_rgb_data()

Retrieve RGB pixel data from the last plot rendered with a PBM color terminal.

**Syntax:**
```lua
local data, error = gnuplot.get_rgb_data()
```

**Returns:**
- On success: table with RGB data
  ```lua
  {
    width = number,       -- Image width in pixels
    height = number,      -- Image height in pixels
    data = string         -- Raw RGB bytes (width * height * 3 bytes)
  }
  ```
- On error: `nil, error_message`

**RGB Data Format:**
- Byte sequence: `R1 G1 B1 R2 G2 B2 R3 G3 B3 ...`
- Each pixel is 3 bytes (R, G, B), values 0-255
- Pixels ordered left-to-right, top-to-bottom
- Total size: `width * height * 3` bytes

**Example:**
```lua
gnuplot.init()

-- Use PBM color terminal
gnuplot.cmd("set terminal pbm color size 800,600")
gnuplot.cmd("set output '/dev/null'")  -- Don't write to file
gnuplot.cmd("plot sin(x)")

-- Get RGB data
local rgb_data, err = gnuplot.get_rgb_data()

if rgb_data then
  print("Image size:", rgb_data.width, "x", rgb_data.height)
  print("Data bytes:", #rgb_data.data)

  -- Access pixel data
  local data = rgb_data.data
  local pixel1_r = string.byte(data, 1)
  local pixel1_g = string.byte(data, 2)
  local pixel1_b = string.byte(data, 3)

  print("First pixel RGB:", pixel1_r, pixel1_g, pixel1_b)
else
  print("Error:", err)
end

gnuplot.close()
```

**Use Cases:**
- Direct GUI rendering (wxWidgets, Qt, GTK, etc.)
- Network streaming of plot images
- Custom image processing
- Real-time visualization
- Avoiding file I/O overhead

---

## Complete Examples

### Example 1: Simple Plot to File

```lua
local gnuplot = require("gnuplot")

gnuplot.init()

-- SVG output
gnuplot.cmd("set terminal svg size 800,600")
gnuplot.cmd("set output 'sine_wave.svg'")
gnuplot.cmd("set title 'Sine Wave'")
gnuplot.cmd("set xlabel 'x'")
gnuplot.cmd("set ylabel 'sin(x)'")
gnuplot.cmd("set grid")
gnuplot.cmd("plot sin(x)")

gnuplot.close()
print("Plot saved to sine_wave.svg")
```

### Example 2: Multiple Functions

```lua
local gnuplot = require("gnuplot")

gnuplot.init()

gnuplot.cmd("set terminal png size 1024,768")
gnuplot.cmd("set output 'trig_functions.png'")
gnuplot.cmd("set title 'Trigonometric Functions'")
gnuplot.cmd("set xlabel 'x'")
gnuplot.cmd("set ylabel 'y'")
gnuplot.cmd("set grid")
gnuplot.cmd("set key top right box")
gnuplot.cmd("set xrange [-2*pi:2*pi]")
gnuplot.cmd("set yrange [-1.5:1.5]")

gnuplot.cmd([[plot sin(x) title 'sin(x)' with lines lw 2, \
                   cos(x) title 'cos(x)' with lines lw 2, \
                   sin(x)*cos(x) title 'sin(x)cos(x)' with lines lw 2]])

gnuplot.close()
print("Plot saved to trig_functions.png")
```

### Example 3: Data from Lua Table

```lua
local gnuplot = require("gnuplot")

-- Generate data
local data = {}
for i = 1, 100 do
  local x = (i - 50) / 10
  local y = x * x - 2 * x + 1
  table.insert(data, string.format("%f %f", x, y))
end

-- Write data to temp file
local f = io.open("tempdata.txt", "w")
f:write(table.concat(data, "\n"))
f:close()

gnuplot.init()

gnuplot.cmd("set terminal svg size 800,600")
gnuplot.cmd("set output 'parabola.svg'")
gnuplot.cmd("set title 'Parabola from Data'")
gnuplot.cmd("set grid")
gnuplot.cmd("plot 'tempdata.txt' with lines title 'y = xÂ² - 2x + 1'")

gnuplot.close()

-- Clean up
os.remove("tempdata.txt")
print("Plot saved to parabola.svg")
```

### Example 4: 3D Surface Plot

```lua
local gnuplot = require("gnuplot")

gnuplot.init()

gnuplot.cmd("set terminal pngcairo size 1200,900")
gnuplot.cmd("set output 'surface.png'")
gnuplot.cmd("set title '3D Surface Plot'")
gnuplot.cmd("set xlabel 'X'")
gnuplot.cmd("set ylabel 'Y'")
gnuplot.cmd("set zlabel 'Z'")
gnuplot.cmd("set hidden3d")
gnuplot.cmd("set pm3d")
gnuplot.cmd("set palette rgbformulae 33,13,10")

gnuplot.cmd("splot sin(sqrt(x**2 + y**2))/sqrt(x**2 + y**2)")

gnuplot.close()
print("3D plot saved to surface.png")
```

### Example 5: wxLua Terminal (Minimal)

```lua
package.cpath = './?.so;;'

local gnuplot = require("gnuplot")

gnuplot.init()
gnuplot.cmd("set terminal wxlua size 800,600")
gnuplot.cmd("plot sin(x), cos(x)")

local result = gnuplot.get_commands()
gnuplot.close()

if result then
  print("Captured", #result.commands, "drawing commands")
  print("Canvas size:", result.width, "x", result.height)

  -- Render these commands with wxWidgets
  -- (See wxlua_plot_perfect.lua for complete implementation)
end
```

## Error Handling

The module functions don't return error values directly. Gnuplot errors are typically printed to stderr.

```lua
local gnuplot = require("gnuplot")

gnuplot.init()

-- This will print an error to stderr but won't crash
gnuplot.cmd("invalid command here")

-- Check results for functions that return values
local result = gnuplot.get_commands()
if not result then
  print("No commands captured - did you use wxlua terminal?")
end

local rgb, err = gnuplot.get_rgb_data()
if not rgb then
  print("RGB data error:", err)
end

gnuplot.close()
```

## See Also

- [Advanced Topics](ADVANCED.md) - Terminal architecture, wxLua implementation details
- [examples.lua](../examples.lua) - More example scripts
- [wxlua_plot_perfect.lua](../wxlua_plot_perfect.lua) - Complete wxLua rendering example
